// flatten{{$.GetPrefix}}{{$.TitlelizeProperty}} converts the API response for Entry Link aspects into a
// Terraform-compatible slice. It normalizes JSON data fields, maps keys, and sorts the aspects
// (preferring configuration order, but falling back to alphabetical sorting for imports).
func flatten{{$.GetPrefix}}{{$.TitlelizeProperty}}(v interface{}, d *schema.ResourceData, config *transport_tpg.Config) interface{} {
	if v == nil {
		return []interface{}{}
	}

	l, ok := v.([]interface{})
	if !ok {
		return []interface{}{}
	}

	transformed := make([]map[string]interface{}, 0, len(l))

	for _, raw := range l {
		original, ok := raw.(map[string]interface{})
		if !ok {
			continue
		}

		item := map[string]interface{}{}

		// Normalize key names
		if val, ok := original["aspectType"]; ok {
			item["aspect_type"] = val
		} else if val, ok := original["aspect_type"]; ok {
			item["aspect_type"] = val
		}

		if dataVal, ok := original["data"]; ok {
			if dataMap, ok := dataVal.(map[string]interface{}); ok {
				b, err := json.Marshal(dataMap)
				if err != nil {
					log.Printf("[ERROR] Failed to marshal 'data' aspect: %s", err)
				}
				item["data"] = string(b)
			} else if dataStr, ok := dataVal.(string); ok {
				item["data"] = dataStr
			}
		}

		transformed = append(transformed, item)
	}

	// Stable alphabetical sort by aspect_type for imports
	sort.Slice(transformed, func(i, j int) bool {
		typeA, _ := transformed[i]["aspect_type"].(string)
		typeB, _ := transformed[j]["aspect_type"].(string)
		return typeA < typeB
	})

	// Reorder based on user's .tf configuration to avoid state jitter
	if configList, ok := d.GetOk("aspects"); ok {
		rawList := configList.([]interface{})
		if len(rawList) > 0 {
			configData := make([]map[string]interface{}, 0, len(rawList))
			for _, item := range rawList {
				if m, ok := item.(map[string]interface{}); ok {
					configData = append(configData, m)
				}
			}
			sorted, err := tpgresource.SortMapsByConfigOrder(configData, transformed, "aspect_type")
			if err == nil {
				return sorted
			}
		}
	}
	return transformed
}